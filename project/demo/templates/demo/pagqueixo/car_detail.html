{% extends "base.html" %}
{% load humanize widget_tweaks %}

{% block title %}{{ car.make }} {{ car.model }} ({{ car.year }}) · Wrenchly{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="glass p-4">
        <!-- Header -->
        <div class="hero p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <a href="{% url 'dashboard' %}" class="text-decoration-none">&larr; Voltar</a>
                    <h3 class="mb-1">{{ car.make }} {{ car.model }} ({{ car.year }})</h3>
                    <div class="vin">VIN: {{ car.vin|default:"—" }} · {{ car.kms_current|intcomma }} km</div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'car_edit' car.pk %}" class="btn btn-outline-light btn-sm">Editar</a>
                    <form method="post" action="{% url 'car_delete' car.pk %}"
                        onsubmit="return confirm('Apagar este carro?');">
                        {% csrf_token %}<button class="btn btn-danger btn-sm">Apagar</button>
                    </form>
                </div>
            </div>
        </div>


        <div class="glass p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-semibold">Problemas crónicos</span>
                <form method="post" action="{% url 'car_import_templates' car.pk %}">
                    {% csrf_token %}<button class="btn btn-sm btn-outline-light">Importar problemas frequentes</button>
                </form>
            </div>

            {% if car.chronic_issues.all %}
            <div class="vstack gap-2">
                {% for p in car.chronic_issues.all %}
                <div
                    class="issue-card {% if p.severity == 'Alta' %}issue-high{% elif p.severity == 'Média' %}issue-medium{% else %}issue-low{% endif %}">
                    <div class="d-flex gap-3 align-items-start">
                        <div class="issue-icon">
                            {% if p.severity == 'Alta' %}&#9888;{% elif p.severity == 'Média' %}&#9881;{% else
                            %}&#10003;{% endif %}
                        </div>
                        <div class="flex-grow-1">
                            <div class="issue-title">{{ p.title }}</div>
                            {% if p.description %}<div class="mt-1">{{ p.description }}</div>{% endif %}
                            <div class="issue-meta mt-1">
                                Severidade: <strong>{{ p.severity }}</strong> · desde {{ p.first_seen_date|date:"d/m/Y"
                                }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-dim">Sem registos.</div>
            {% endif %}
        </div>


        <!-- Manutenções -->
        <div class="glass p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Manutenções</h6>
                <span class="badge badge-soft">{{ car.maintenances.all|length }}</span>
            </div>

            {% if car.maintenances.all %}
            <div class="timeline mb-3">
                {% for m in car.maintenances.all %}
                <div class="tl-item {% if m.completed %}done{% endif %} mb-3">
                    <div class="tl-card">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="fw-semibold text-light">{{ m.description }}</div>
                                <div class="small text-dim">
                                    {% if m.due_date %}Prazo: {{ m.due_date|date:"d/m/Y" }}{% endif %}
                                    {% if m.due_km %}{% if m.due_date %} · {% endif %}Km alvo: {{
                                    m.due_km|floatformat:0|intcomma }}{% endif %}
                                    · Criado em {{ m.created_at|date:"d/m/Y H:i" }}
                                </div>
                                {% if m.notes %}<div class="small mt-1 text-dim">{{ m.notes }}</div>{% endif %}
                            </div>
                            <span
                                class="badge {% if m.completed %}text-bg-success{% else %}text-bg-secondary{% endif %}">
                                {% if m.completed %}Concluída{% else %}Pendente{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-dim mb-3">Sem registos.</div>
            {% endif %}

            <!-- Form -->
            <form method="post" class="maint-form p-3">
                {% csrf_token %}
                <div class="mb-3">
                    <label class="form-label" for="description">O que foi feito / deve ser feito?</label>
                    <textarea id="description" name="description" rows="3" class="form-control"
                        placeholder="Ex.: Troca de óleo 5W30, filtro de óleo, inspeção correia..."></textarea>
                </div>

                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label" for="due_date">Prazo (data)</label>
                        <input id="due_date" name="due_date" type="date" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="due_km">Km alvo</label>
                        <input id="due_km" name="due_km" type="number" min="0" step="100" class="form-control"
                            placeholder="Ex.: 205000">
                    </div>
                    <div class="col-md-2 form-check ms-2">
                        <input class="form-check-input" type="checkbox" id="completed" name="completed">
                        <label class="form-check-label" for="completed">Concluída</label>
                    </div>
                    <div class="col-md-2 text-end maint-actions">
                        <button type="submit" name="add_maintenance" value="1" class="btn btn-primary w-100">
                            Adicionar manutenção
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
</div>
</div>
</div>
{% endblock %}