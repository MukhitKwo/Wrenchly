{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wrenchly — Dashboard</title>
    {% csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        :root {
            --bg: #0b1220;
            --card: #0f172a;
            --muted: #94a3b8;
            --line: #1f2a44;
        }

        body {
            background: var(--bg);
            color: #e6edf3;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
        }

        .nav-tabs .nav-link.active {
            background: transparent;
            border-color: transparent transparent var(--muted);
            border-bottom: 2px solid #60a5fa;
            color: #fff;
        }

        .table thead th {
            color: #9fb4ff;
            text-transform: uppercase;
            font-size: .8rem;
            letter-spacing: .04em;
            border-bottom-color: #223154;
        }

        .form-control,
        .form-select,
        .form-control:focus,
        .form-select:focus {
            background: #0b1220;
            color: #e6edf3;
            border-color: #24324f;
        }

        .modal-content {
            background: var(--card);
            color: #e6edf3;
            border: 1px solid var(--line);
        }

        .btn-primary {
            background: #4f46e5;
            border: none;
        }

        .btn-outline-light {
            border-color: #334155;
            color: #dbeafe;
        }

        .btn-outline-light:hover {
            background: #1e293b;
        }

        small.muted {
            color: var(--muted);
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h1 class="h3 m-0">Wrenchly — Gestão de Carros</h1>
            <div class="d-flex gap-2">
                <form action="/logout/" method="post">
                    {% csrf_token %}
                    <button class="btn btn-outline-light">Terminar sessão</button>
                </form>


            </div>
        </div>

        <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-carros" data-bs-toggle="tab" data-bs-target="#pane-carros"
                    type="button" role="tab">Carros</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-issues" data-bs-toggle="tab" data-bs-target="#pane-issues"
                    type="button" role="tab">Problemas crónicos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-manut" data-bs-toggle="tab" data-bs-target="#pane-manut" type="button"
                    role="tab">Manutenções</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- ===================== CARROS ===================== -->
            <div class="tab-pane fade show active" id="pane-carros" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="input-group" style="max-width: 420px;">
                                <span class="input-group-text">Pesquisar</span>
                                <input id="searchCars" class="form-control" placeholder="marca, modelo, VIN..."
                                    oninput="filterCars()" />
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCar"
                                    onclick="openCarCreate()">+ Adicionar carro</button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-dark table-hover align-middle" id="tableCars">
                                <thead>
                                    <tr>
                                        <th style="width:70px;">ID</th>
                                        <th>Marca</th>
                                        <th>Modelo</th>
                                        <th>Ano</th>
                                        <th>KM</th>
                                        <th>VIN</th>
                                        <th style="width:160px;" class="text-end">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyCars"></tbody>
                            </table>
                        </div>
                        <small id="countCars" class="muted"></small>
                    </div>
                </div>
            </div>

            <!-- ===================== PROBLEMAS CRÓNICOS ===================== -->
            <div class="tab-pane fade" id="pane-issues" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Filtrar por carro</label>
                                <select id="filterIssueCar" class="form-select" onchange="loadIssues()"></select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Pesquisar</label>
                                <input id="searchIssues" class="form-control" placeholder="título/descrição..."
                                    oninput="filterIssuesLocal()" />
                            </div>
                            <div class="col-md-4 d-flex align-items-end justify-content-end">
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalIssue"
                                    onclick="openIssueCreate()">+ Adicionar problema</button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-dark table-hover align-middle" id="tableIssues">
                                <thead>
                                    <tr>
                                        <th style="width:70px;">ID</th>
                                        <th>Carro</th>
                                        <th>Título</th>
                                        <th>Severidade</th>
                                        <th>Primeira ocorrência</th>
                                        <th class="text-end" style="width:160px;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyIssues"></tbody>
                            </table>
                        </div>
                        <small id="countIssues" class="muted"></small>
                    </div>
                </div>
            </div>

            <!-- ===================== MANUTENÇÕES ===================== -->
            <div class="tab-pane fade" id="pane-manut" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Filtrar por carro</label>
                                <select id="filterMaintCar" class="form-select" onchange="loadMaints()"></select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tipo</label>
                                <select id="filterMaintKind" class="form-select" onchange="filterMaintLocal()">
                                    <option value="">Todos</option>
                                    <option value="preventive">Preventiva</option>
                                    <option value="corrective">Corretiva</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Estado</label>
                                <select id="filterMaintDone" class="form-select" onchange="filterMaintLocal()">
                                    <option value="">Todos</option>
                                    <option value="open">Em aberto</option>
                                    <option value="done">Concluídos</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end justify-content-end">
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalMaint"
                                    onclick="openMaintCreate()">+ Adicionar manutenção</button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-dark table-hover align-middle" id="tableMaint">
                                <thead>
                                    <tr>
                                        <th style="width:70px;">ID</th>
                                        <th>Carro</th>
                                        <th>Tarefa</th>
                                        <th>Tipo</th>
                                        <th>Prevista (data/km)</th>
                                        <th>Concluída (data/km)</th>
                                        <th>Custo</th>
                                        <th class="text-end" style="width:170px;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyMaint"></tbody>
                            </table>
                        </div>
                        <small id="countMaint" class="muted"></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================== MODAL CARRO ===================== -->
    <div class="modal fade" id="modalCar" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form onsubmit="submitCar(event)">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalCarTitle">Novo carro</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="carId">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Marca</label>
                                <input id="carMake" class="form-control" required />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Modelo</label>
                                <input id="carModel" class="form-control" required />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Ano</label>
                                <input id="carYear" type="number" min="1900" max="2100" class="form-control" required />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">KM atuais</label>
                                <input id="carKms" type="number" min="0" step="1" class="form-control" value="0"
                                    required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">VIN</label>
                                <input id="carVin" class="form-control" placeholder="opcional" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Especificações (JSON)</label>
                                <textarea id="carSpecs" class="form-control" rows="4"
                                    placeholder='{"motor":"1.3","óleo":"5W30"}'></textarea>
                                <small class="muted">Dica: mantém um JSON válido. Se vazio, será guardado como objeto
                                    vazio { }.</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline-light" type="button" data-bs-dismiss="modal">Cancelar</button>
                        <button class="btn btn-primary" type="submit">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ===================== MODAL PROBLEMA CRÓNICO ===================== -->
    <div class="modal fade" id="modalIssue" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form onsubmit="submitIssue(event)">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalIssueTitle">Novo problema crónico</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="issueId">
                        <div class="mb-3">
                            <label class="form-label">Carro</label>
                            <select id="issueCar" class="form-select" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Título</label>
                            <input id="issueTitle" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <textarea id="issueDesc" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Severidade</label>
                                <select id="issueSeverity" class="form-select" required>
                                    <option value="low">Baixa</option>
                                    <option value="med" selected>Média</option>
                                    <option value="high">Alta</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Primeira ocorrência</label>
                                <input id="issueFirstSeen" type="date" class="form-control" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline-light" type="button" data-bs-dismiss="modal">Cancelar</button>
                        <button class="btn btn-primary" type="submit">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ===================== MODAL MANUTENÇÃO ===================== -->
    <div class="modal fade" id="modalMaint" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form onsubmit="submitMaint(event)">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalMaintTitle">Nova manutenção</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="maintId">
                        <div class="mb-3">
                            <label class="form-label">Carro</label>
                            <select id="maintCar" class="form-select" required></select>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Tipo</label>
                                <select id="maintKind" class="form-select" required>
                                    <option value="preventive">Preventiva</option>
                                    <option value="corrective">Corretiva</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tarefa</label>
                                <input id="maintTitle" class="form-control" placeholder="ex.: Troca de óleo" required />
                            </div>
                        </div>
                        <div class="row g-3 mt-1">
                            <div class="col-md-6">
                                <label class="form-label">Data prevista</label>
                                <input id="maintDueDate" type="date" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">KM previstos</label>
                                <input id="maintDueKm" type="number" min="0" step="1" class="form-control" />
                            </div>
                        </div>
                        <hr />
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Concluída?</label>
                                <select id="maintCompleted" class="form-select">
                                    <option value="false" selected>Não</option>
                                    <option value="true">Sim</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Data conclusão</label>
                                <input id="maintCompletedAt" type="date" class="form-control" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">KM conclusão</label>
                                <input id="maintCompletedKm" type="number" min="0" step="1" class="form-control" />
                            </div>
                            <div class="col-12 mt-1">
                                <label class="form-label">Custo (€)</label>
                                <input id="maintCost" type="number" step="0.01" min="0" class="form-control" />
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Notas</label>
                            <textarea id="maintNotes" class="form-control" rows="3"
                                placeholder="Observações, material usado, referência do óleo, etc."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline-light" type="button" data-bs-dismiss="modal">Cancelar</button>
                        <button class="btn btn-primary" type="submit">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toasts -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
        <div id="toast" class="toast text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toastBody">Mensagem</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ======= Endpoints DRF =======
        const API_CARS = "/api/cars/";
        const API_ISS = "/api/chronic-issues/";
        const API_MNT = "/api/maintenances/";

        // ======= CSRF =======
        function getCookie(name) { const v = `; ${document.cookie}`; const p = v.split(`; ${name}=`); if (p.length === 2) return p.pop().split(';').shift(); }
        const CSRF = getCookie('csrftoken') || document.querySelector('meta[name="csrf-token"]').content;
        function toast(msg) { document.getElementById('toastBody').textContent = msg; new bootstrap.Toast(document.getElementById('toast')).show(); }

        // ======= CARROS =======
        const tbodyCars = document.getElementById('tbodyCars');
        const countCars = document.getElementById('countCars');
        const searchCars = document.getElementById('searchCars');

        const carModal = new bootstrap.Modal(document.getElementById('modalCar'));
        const modalCarTitle = document.getElementById('modalCarTitle');
        const carId = document.getElementById('carId');
        const carMake = document.getElementById('carMake');
        const carModel = document.getElementById('carModel');
        const carYear = document.getElementById('carYear');
        const carKms = document.getElementById('carKms');
        const carVin = document.getElementById('carVin');
        const carSpecs = document.getElementById('carSpecs');

        let carsCache = [];

        async function loadCars() {
            const r = await fetch(API_CARS);
            const data = await r.json();
            carsCache = data;
            renderCars(data);
            fillCarSelects();
        }

        function renderCars(rows) {
            tbodyCars.innerHTML = "";
            rows.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td class="text-secondary">#${c.id}</td>
          <td>${esc(c.make)}</td>
          <td>${esc(c.model)}</td>
          <td>${c.year ?? ''}</td>
          <td>${c.kms_current ?? 0}</td>
          <td>${esc(c.vin || '')}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-light me-2" onclick="openCarEdit(${c.id})">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="delCar(${c.id})">Apagar</button>
          </td>`;
                tbodyCars.appendChild(tr);
            });
            countCars.textContent = rows.length ? `${rows.length} carro(s)` : 'Sem registos';
            filterCars();
        }

        function openCarCreate() {
            carId.value = "";
            carMake.value = ""; carModel.value = ""; carYear.value = ""; carKms.value = 0; carVin.value = ""; carSpecs.value = "";
            modalCarTitle.textContent = 'Novo carro';
        }

        function openCarEdit(id) {
            const c = carsCache.find(x => x.id === id); if (!c) return;
            carId.value = c.id;
            carMake.value = c.make || "";
            carModel.value = c.model || "";
            carYear.value = c.year || "";
            carKms.value = c.kms_current || 0;
            carVin.value = c.vin || "";
            carSpecs.value = c.specs ? JSON.stringify(c.specs, null, 2) : "";
            modalCarTitle.textContent = `Editar carro #${c.id}`;
            carModal.show();
        }

        async function submitCar(e) {
            e.preventDefault();
            let specs = {};
            if (carSpecs.value.trim()) {
                try { specs = JSON.parse(carSpecs.value); }
                catch { return toast('Especificações: JSON inválido.'); }
            }
            const payload = {
                make: carMake.value.trim(),
                model: carModel.value.trim(),
                year: parseInt(carYear.value, 10),
                kms_current: parseInt(carKms.value, 10) || 0,
                vin: carVin.value.trim() || null,
                specs
            };
            const id = carId.value;
            const res = await fetch(id ? `${API_CARS}${id}/` : API_CARS, {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
                body: JSON.stringify(payload)
            });
            if (res.ok) { carModal.hide(); toast(id ? 'Carro atualizado!' : 'Carro criado!'); await loadCars(); }
            else { toast('Erro: ' + (await res.text()).slice(0, 200)); }
        }

        async function delCar(id) {
            if (!confirm(`Apagar carro #${id}?`)) return;
            const res = await fetch(`${API_CARS}${id}/`, { method: 'DELETE', headers: { 'X-CSRFToken': CSRF } });
            if (res.status === 204) { toast('Carro apagado.'); await loadCars(); }
            else toast('Não foi possível apagar.');
        }

        function filterCars() {
            const q = searchCars.value.toLowerCase().trim();
            [...tbodyCars.querySelectorAll('tr')].forEach(tr => {
                const text = tr.textContent.toLowerCase();
                tr.style.display = text.includes(q) ? '' : 'none';
            });
        }

        function fillCarSelects() {
            const opts = ['<option value="">(todos)</option>']
                .concat(carsCache.map(c => `<option value="${c.id}">${esc(c.make)} ${esc(c.model)} ${c.year || ''} (#${c.id})</option>`))
                .join('');
            const optsReq = carsCache.map(c => `<option value="${c.id}">${esc(c.make)} ${esc(c.model)} ${c.year || ''} (#${c.id})</option>`).join('');
            document.getElementById('filterIssueCar').innerHTML = '<option value="">(todos)</option>' + optsReq;
            document.getElementById('filterMaintCar').innerHTML = '<option value="">(todos)</option>' + optsReq;
            document.getElementById('issueCar').innerHTML = optsReq;
            document.getElementById('maintCar').innerHTML = optsReq;
        }

        // ======= PROBLEMAS CRÓNICOS =======
        const tbodyIssues = document.getElementById('tbodyIssues');
        const countIssues = document.getElementById('countIssues');
        const searchIssues = document.getElementById('searchIssues');
        const filterIssueCar = document.getElementById('filterIssueCar');

        const issueModal = new bootstrap.Modal(document.getElementById('modalIssue'));
        const issueId = document.getElementById('issueId');
        const issueCar = document.getElementById('issueCar');
        const issueTitle = document.getElementById('issueTitle');
        const issueDesc = document.getElementById('issueDesc');
        const issueSeverity = document.getElementById('issueSeverity');
        const issueFirstSeen = document.getElementById('issueFirstSeen');

        let issuesCache = [];

        async function loadIssues() {
            const car = filterIssueCar.value;
            const url = car ? `${API_ISS}?search=&ordering=&car=${car}` : API_ISS; // DRF não expõe car por default; faremos filtro local
            const r = await fetch(API_ISS); // carrega todos e filtra local
            const data = await r.json();
            issuesCache = data;
            renderIssues();
        }

        function renderIssues() {
            let rows = issuesCache;
            const car = filterIssueCar.value;
            if (car) rows = rows.filter(x => String(x.car) === String(car));
            tbodyIssues.innerHTML = rows.map(i => {
                const carTxt = carLabel(i.car);
                const sev = i.severity === 'high' ? 'Alta' : (i.severity === 'low' ? 'Baixa' : 'Média');
                return `<tr>
          <td class="text-secondary">#${i.id}</td>
          <td>${esc(carTxt)}</td>
          <td>${esc(i.title)}</td>
          <td>${esc(sev)}</td>
          <td>${i.first_seen_date || ''}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-light me-2" onclick="openIssueEdit(${i.id})">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="delIssue(${i.id})">Apagar</button>
          </td>
        </tr>`;
            }).join('');
            countIssues.textContent = rows.length ? `${rows.length} problema(s)` : 'Sem registos';
            filterIssuesLocal();
        }

        function openIssueCreate() {
            issueId.value = "";
            issueTitle.value = ""; issueDesc.value = ""; issueSeverity.value = 'med'; issueFirstSeen.value = '';
        }
        function openIssueEdit(id) {
            const i = issuesCache.find(x => x.id === id); if (!i) return;
            issueId.value = id;
            issueCar.value = i.car;
            issueTitle.value = i.title || "";
            issueDesc.value = i.description || "";
            issueSeverity.value = i.severity || 'med';
            issueFirstSeen.value = i.first_seen_date || "";
            issueModal.show();
        }

        async function submitIssue(e) {
            e.preventDefault();
            const payload = {
                car: parseInt(issueCar.value, 10),
                title: issueTitle.value.trim(),
                description: issueDesc.value.trim(),
                severity: issueSeverity.value,
                first_seen_date: issueFirstSeen.value || null,
            };
            const id = issueId.value;
            const res = await fetch(id ? `${API_ISS}${id}/` : API_ISS, {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
                body: JSON.stringify(payload)
            });
            if (res.ok) { issueModal.hide(); toast(id ? 'Problema atualizado!' : 'Problema criado!'); await loadIssues(); }
            else toast('Erro: ' + (await res.text()).slice(0, 200));
        }

        async function delIssue(id) {
            if (!confirm(`Apagar problema #${id}?`)) return;
            const res = await fetch(`${API_ISS}${id}/`, { method: 'DELETE', headers: { 'X-CSRFToken': CSRF } });
            if (res.status === 204) { toast('Problema apagado.'); await loadIssues(); }
            else toast('Não foi possível apagar.');
        }

        function filterIssuesLocal() {
            const q = searchIssues.value.toLowerCase().trim();
            [...tbodyIssues.querySelectorAll('tr')].forEach(tr => {
                tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
            });
        }

        // ======= MANUTENÇÕES =======
        const tbodyMaint = document.getElementById('tbodyMaint');
        const countMaint = document.getElementById('countMaint');
        const filterMaintCar = document.getElementById('filterMaintCar');
        const filterMaintKind = document.getElementById('filterMaintKind');
        const filterMaintDone = document.getElementById('filterMaintDone');

        const maintModal = new bootstrap.Modal(document.getElementById('modalMaint'));
        const maintId = document.getElementById('maintId');
        const maintCar = document.getElementById('maintCar');
        const maintKind = document.getElementById('maintKind');
        const maintTitle = document.getElementById('maintTitle');
        const maintNotes = document.getElementById('maintNotes');
        const maintDueDate = document.getElementById('maintDueDate');
        const maintDueKm = document.getElementById('maintDueKm');
        const maintCompleted = document.getElementById('maintCompleted');
        const maintCompletedAt = document.getElementById('maintCompletedAt');
        const maintCompletedKm = document.getElementById('maintCompletedKm');
        const maintCost = document.getElementById('maintCost');

        let maintCache = [];

        async function loadMaints() {
            const r = await fetch(API_MNT);
            maintCache = await r.json();
            renderMaint();
        }

        function renderMaint() {
            let rows = maintCache;
            const car = filterMaintCar.value;
            if (car) rows = rows.filter(x => String(x.car) === String(car));
            tbodyMaint.innerHTML = rows.map(m => {
                const carTxt = carLabel(m.car);
                const kind = m.kind === 'preventive' ? 'Preventiva' : 'Corretiva';
                const prevista = `${m.due_date || '-'} / ${m.due_km || '-'}`;
                const concluida = m.completed ? `${m.completed_at || '-'} / ${m.completed_km || '-'}` : '—';
                const custo = m.cost ? `€ ${Number(m.cost).toFixed(2)}` : '—';
                return `<tr data-kind="${m.kind}" data-done="${m.completed}">
          <td class="text-secondary">#${m.id}</td>
          <td>${esc(carTxt)}</td>
          <td>${esc(m.title || '')}</td>
          <td>${kind}</td>
          <td>${prevista}</td>
          <td>${concluida}</td>
          <td>${custo}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-light me-2" onclick="openMaintEdit(${m.id})">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="delMaint(${m.id})">Apagar</button>
          </td>
        </tr>`;
            }).join('');
            countMaint.textContent = rows.length ? `${rows.length} manutenção(ões)` : 'Sem registos';
            filterMaintLocal();
        }

        function openMaintCreate() {
            maintId.value = "";
            maintCar.value = maintCar.options[0]?.value || "";
            maintKind.value = 'preventive';
            maintTitle.value = '';
            maintNotes.value = '';
            maintDueDate.value = '';
            maintDueKm.value = '';
            maintCompleted.value = 'false';
            maintCompletedAt.value = '';
            maintCompletedKm.value = '';
            maintCost.value = '';
        }

        function openMaintEdit(id) {
            const m = maintCache.find(x => x.id === id); if (!m) return;
            maintId.value = id;
            maintCar.value = m.car;
            maintKind.value = m.kind;
            maintTitle.value = m.title || '';
            maintNotes.value = m.notes || '';
            maintDueDate.value = m.due_date || '';
            maintDueKm.value = m.due_km || '';
            maintCompleted.value = String(!!m.completed);
            maintCompletedAt.value = m.completed_at || '';
            maintCompletedKm.value = m.completed_km || '';
            maintCost.value = m.cost || '';
            maintModal.show();
        }

        async function submitMaint(e) {
            e.preventDefault();
            const payload = {
                car: parseInt(maintCar.value, 10),
                kind: maintKind.value,
                title: maintTitle.value.trim(),
                notes: maintNotes.value.trim(),
                due_date: maintDueDate.value || null,
                due_km: maintDueKm.value ? parseInt(maintDueKm.value, 10) : null,
                completed: maintCompleted.value === 'true',
                completed_at: maintCompletedAt.value || null,
                completed_km: maintCompletedKm.value ? parseInt(maintCompletedKm.value, 10) : null,
                cost: maintCost.value ? maintCost.value : null,
            };
            const id = maintId.value;
            const res = await fetch(id ? `${API_MNT}${id}/` : API_MNT, {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
                body: JSON.stringify(payload)
            });
            if (res.ok) { maintModal.hide(); toast(id ? 'Manutenção atualizada!' : 'Manutenção criada!'); await loadMaints(); }
            else toast('Erro: ' + (await res.text()).slice(0, 200));
        }

        async function delMaint(id) {
            if (!confirm(`Apagar manutenção #${id}?`)) return;
            const res = await fetch(`${API_MNT}${id}/`, { method: 'DELETE', headers: { 'X-CSRFToken': CSRF } });
            if (res.status === 204) { toast('Manutenção apagada.'); await loadMaints(); }
            else toast('Não foi possível apagar.');
        }

        function filterMaintLocal() {
            const kind = filterMaintKind.value; // preventive/corrective/""
            const done = filterMaintDone.value; // open/done/""
            [...tbodyMaint.querySelectorAll('tr')].forEach(tr => {
                const k = tr.getAttribute('data-kind');
                const d = tr.getAttribute('data-done') === 'true' ? 'done' : 'open';
                const okKind = !kind || k === kind;
                const okDone = !done || d === done;
                tr.style.display = (okKind && okDone) ? '' : 'none';
            });
        }

        // ======= Helpers =======
        function esc(s) { return String(s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#039;' }[m])); }
        function carLabel(id) {
            const c = carsCache.find(x => x.id === id);
            return c ? `${c.make} ${c.model} ${c.year || ''}` : `#${id}`;
        }

        // ======= Boot =======
        (async function () {
            await loadCars();
            await loadIssues();
            await loadMaints();
        })();
    </script>
</body>

</html>