<!doctype html>
<html lang="pt">

<head>
    <meta charset="utf-8">
    <title>{{ app_name|default:"Wrenchly" }} — Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #0b1220;
            color: #e6edf3;
        }

        .card {
            background: #0f172a;
            border: 1px solid #1f2a44;
        }

        .table thead th {
            border-bottom-color: #223154;
            color: #9fb4ff;
            text-transform: uppercase;
            font-size: .8rem;
            letter-spacing: .04em;
        }

        .table tbody tr {
            vertical-align: middle;
        }

        .btn-primary {
            background: #4f46e5;
            border: none;
        }

        .btn-outline-light {
            border-color: #334155;
            color: #dbeafe;
        }

        .btn-outline-light:hover {
            background: #1e293b;
        }

        .form-control,
        .form-control:focus {
            background: #0b1220;
            color: #e6edf3;
            border-color: #24324f;
        }

        .modal-content {
            background: #0f172a;
            color: #e6edf3;
            border: 1px solid #223154;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h1 class="h3 m-0">{{ app_name|default:"Wrenchly" }}</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#itemModal" onclick="openCreate()">+
                Adicionar</button>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="input-group" style="max-width: 360px;">
                        <span class="input-group-text">Pesquisar</span>
                        <input id="searchInput" class="form-control" placeholder="nome..." oninput="filterTable()">
                    </div>
                    <small class="text-secondary" id="countLabel"></small>
                </div>

                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle" id="dataTable">
                        <thead>
                            <tr>
                                <th style="width:100px;">ID</th>
                                <th>Nome</th>
                                <th class="text-end" style="width:210px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Create/Edit -->
    <div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form onsubmit="submitForm(event)">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Novo registo</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="itemId">
                        <div class="mb-3">
                            <label class="form-label">Nome</label>
                            <input id="nameInput" class="form-control" required maxlength="100"
                                placeholder="ex.: Maria">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline-light" type="button" data-bs-dismiss="modal">Cancelar</button>
                        <button class="btn btn-primary" type="submit">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toasts -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
        <div id="toast" class="toast text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toastBody">Mensagem</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = "/api/cars/"; // endpoints DRF
        const tbody = document.getElementById("tbody");
        const nameInput = document.getElementById("nameInput");
        const itemId = document.getElementById("itemId");
        const modalTitle = document.getElementById("modalTitle");
        const itemModal = new bootstrap.Modal(document.getElementById('itemModal'));
        const toastEl = document.getElementById('toast');
        const toastBody = document.getElementById('toastBody');
        const countLabel = document.getElementById('countLabel');

        function toast(msg) { toastBody.textContent = msg; new bootstrap.Toast(toastEl).show(); }
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        const CSRF = getCookie('csrftoken') || document.querySelector('meta[name="csrf-token"]').content;

        async function loadData() {
            const res = await fetch(API);
            const data = await res.json();
            renderRows(data);
        }

        function renderRows(rows) {
            tbody.innerHTML = "";
            rows.forEach(r => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td class="text-secondary">#${r.id}</td>
          <td>${escapeHtml(r.name)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-light me-2" onclick="openEdit(${r.id}, '${escapeAttr(r.name)}')">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="del(${r.id})">Apagar</button>
          </td>`;
                tbody.appendChild(tr);
            });
            countLabel.textContent = rows.length ? `${rows.length} registo(s)` : "Sem registos";
            filterTable(); // re-aplicar filtro se houver texto
        }

        function openCreate() {
            itemId.value = "";
            nameInput.value = "";
            modalTitle.textContent = "Novo registo";
        }
        function openEdit(id, name) {
            itemId.value = id;
            nameInput.value = name;
            modalTitle.textContent = `Editar #${id}`;
            itemModal.show();
        }

        async function submitForm(e) {
            e.preventDefault();
            const payload = { name: nameInput.value.trim() };
            if (!payload.name) return;

            const id = itemId.value;
            const opts = {
                method: id ? "PUT" : "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": CSRF },
                body: JSON.stringify(payload)
            };
            const url = id ? `${API}${id}/` : API;
            const res = await fetch(url, opts);

            if (res.ok) {
                itemModal.hide();
                toast(id ? "Atualizado!" : "Criado!");
                await loadData();
            } else {
                const err = await res.text();
                toast("Erro: " + err.slice(0, 120));
            }
        }

        async function del(id) {
            if (!confirm(`Apagar #${id}?`)) return;
            const res = await fetch(`${API}${id}/`, { method: "DELETE", headers: { "X-CSRFToken": CSRF } });
            if (res.status === 204) {
                toast("Apagado!");
                await loadData();
            } else {
                toast("Não foi possível apagar.");
            }
        }

        function filterTable() {
            const q = document.getElementById("searchInput").value.toLowerCase().trim();
            [...tbody.querySelectorAll("tr")].forEach(tr => {
                const name = tr.children[1].textContent.toLowerCase();
                tr.style.display = name.includes(q) ? "" : "none";
            });
        }

        // Helpers de segurança
        function escapeHtml(s) { return s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])); }
        function escapeAttr(s) { return s.replace(/'/g, "\\'").replace(/"/g, '&quot;'); }

        loadData();
    </script>
</body>

</html>